#!/usr/bin/env python3
import sys
import argparse
import os
import signal

import gonullu


def kullanim():
    print("""
Kullanim - Usage

Asagidaki satir, docker için 1 işlemci, fiziksel hafızanın
%50'sini  ayırır.
The command below reserves 1 cpu and %50 of physical memory for
docker.

sudo gonullu --cpu-set=1 --memory-limit=50

""")
    os.system("stty echo")
    sys.exit()


def main(log_main, volunteer_main, farm_main):
    while 1:
        response = farm_main.get_package()
        if response is -1:
            farm_main.wait(message='dir yeni paket bekleniyor.')
        else:
            volunteer_main.get_package_farm(response)
            while 1:
                if volunteer_main.check():
                    # container bulunamadı. İşlem bitti.
                    if farm_main.send_file(response['package']):
                        success = int(open('/tmp/gonullu/%s/%s.bitti' % (response['package'],
                                                                         response['package']), 'r').read())
                        farm_main.get('updaterunning?id=%s&state=%s' % (response['queue_id'], success), json=False)
                        volunteer_main.remove()
                        log_main.success(
                            message='derleme işlemi %s paketi için %s saniyede bitti.' % (response['package'],
                                                                                          farm_main.get_total_time())
                        )
                        log_main.blank_line()
                        farm_main.wait(reset=True)
                    break
                else:
                    # container bulundu. İşlem sürüyor.
                    farm_main.wait(message='den beri derleme işlemi %s paketi için devam ediyor.' % response['package'])


if __name__ == "__main__":
    pisi = gonullu
    log = pisi.Log

    parser = argparse.ArgumentParser(description='This is pisilinux volunteer application')
    parser.add_argument('-k', '--kullanim', action="store_true", dest="kullanim", default=False)
    parser.add_argument('-ml', '--memory-limit', action='store', dest='memory_limit', default=50, type=int)
    parser.add_argument('-msl', '--memory-swap-limit', action='store', dest='memswap_limit', default=50, type=int)
    parser.add_argument('-cs', '--cpu-set', action='store', dest='cpu_set', default=1, type=int)
    parser.add_argument('-e', '--email', action='store', dest='email', default='ilkermanap@gmail.com', type=str)

    if os.getgid() != 0:
        log.error('Lütfen programı yönetici(sudo) olarak çalıştırınız.')
        log.get_exit()

    docker_socket_file = '/var/run/docker.sock'
    if not os.path.exists(docker_socket_file):
        log.error(message='Lütfen ilk önce docker servisini çalıştırınız!')
        log.get_exit()

    args = parser.parse_args()
    print(args)

    if not args.email:
        log.error(message='Lütfen bir mail adresi belirtiniz. (-e parametresi)')
        log.get_exit()

    if args.kullanim:
        kullanim()

    farm = gonullu.Farm('http://ciftlik.pisilinux.org/ciftlik', args.email)
    volunteer = pisi.Volunteer(args)

    # CTRL+C call_exit'e yönlendirildi. Bu sayede çalışan container silinecek ve öyle çıkış yapılacak.
    signal.signal(signal.SIGINT, volunteer.exit_signal)
    # CTRL+Z sinyali iptal edildi.
    signal.signal(signal.SIGTSTP, signal.SIG_IGN)
    try:
        os.system("stty -echo")
        main(log, volunteer, farm)
    finally:
        volunteer.exit_signal()
